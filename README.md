# nobocon calc 仕様書（Codex 開発用・最終版）

## 1. 概要
- **サービス名**：nobocon calc
- **目的**：のぼコン（ボルダリングコンペ）のスコアを、手元で素早く・ミスなく計算できるWebアプリを提供する。
- **想定ユーザー**：選手本人／集計担当／観戦しながら概算したい人
- **公開方法**：GitHub Pages にて静的ホスティング
- **前提**：サーバ不要。入力状態はブラウザ内に一時保存し、リロード等で復帰できる。

---

## 2. 主要機能一覧
1. **級・段ごとの完登数カウント（+/-）**
2. **のぼコンボード（ON/OFF）**
3. **合計点の常時表示（最上部固定）**
4. **入力状態の一時保存（期限付きキャッシュ）**
5. **リセット（全入力を初期化）**

---

## 3. スコア定義

### 3.1 級・段スコア（完登数 × 点数）
| グレード | 点数 |
|---|---:|
| 8Q | 100 |
| 7Q | 200 |
| 6Q | 300 |
| 5Q | 400 |
| 4Q | 500 |
| 3Q | 650 |
| 2Q | 1050 |
| 1Q | 1400 |
| 1D（初段） | 2500 |
| 2D | 4000 |

- 完登数は **0以上の整数**。
- 合計は **各グレードの（完登数 × 点数）の総和**。

### 3.2 のぼコンボード（できた/できなかった）
> のぼコンボードは「できたかできなかったか」の二択。  
> UIはトグル（押したらON、もう一度でOFF）。

| ボード | 点数 |
|---|---:|
| 8Q(91) | 100 |
| 7Q(92) | 200 |
| 6Q(93) | 300 |
| 5Q(94) | 400 |
| 4Q(95) | 500 |
| 3Q(96) | 650 |
| 3Q(97) | 650 |
| 2Q(98) | 1050 |

- 各ボードは **ONなら加点、OFFなら0点**。
- **「全て選択」**を用意：
  - 押下で全ボードをON
  - もう一度押下で全ボードをOFF  
  - （実装容易性優先で、ボタンで実装する）

### 3.3 ランク判定（合計点に応じて表示）
| ランク | 範囲 |
|---|---:|
| ノービス | 0〜2999 |
| I | 3000〜3999 |
| H | 4000〜4999 |
| G | 5000〜5999 |
| F | 6000〜6999 |
| E | 7000〜7999 |
| D | 8000〜8999 |
| C | 9000〜10999 |
| B | 11000〜13999 |
| A | 14000〜17499 |
| S | 17500〜26999 |
| エキスパート | 27000〜39999 |
| アルティメット | 40000〜 |

---

## 4. 画面仕様（単一ページ）

### 4.1 レイアウト要件
- **最上部に合計点を固定表示**（スクロールしても常に見える）
  - 例：sticky header（`position: sticky; top: 0;`）
- その下に入力UI：
  1) 級・段（完登数カウンター一覧）
  2) のぼコンボード（トグル一覧 + 全選択）
  3) リセット・保存状態表示（任意）

### 4.2 級・段の入力UI（カウンター）
- 各行（カード）に以下を表示：
  - グレード名（例：8Q）
  - 点数（例：100pt）
  - **完登数表示（リアルタイム）**
  - `-` ボタン / `+` ボタン
- 操作仕様：
  - `+`：完登数を +1
  - `-`：完登数を -1（ただし **0未満にならない**）
  - 連打しやすいサイズ（スマホ前提：最小44px目安）
- 表示仕様：
  - 完登数の表示はボタンの上（要件）  
    - 例：縦配置で「完登数 → ボタン列」
  - 合計点も操作と同時に即更新

### 4.3 のぼコンボード UI（トグル）
- 各ボードをトグル形式で表示：
  - ラベル（例：8Q(91)）
  - 点数（例：100pt）
  - ON/OFF状態の視覚的差（背景・枠・アイコン等）
- 「全て選択」：
  - ボタンで実装（全ON時は「全て解除」の挙動）
  - ラベル切替（例：`全て選択` ↔ `全て解除`）

### 4.4 合計点表示
- 上部の固定エリアに大きく表示：
  - `合計 12,345 pt`
- 数値は `Intl.NumberFormat('ja-JP')` 等で3桁区切り
- 重要情報として強調（可読性と視認性最優先）

---

## 5. 計算仕様

### 5.1 変数
- `counts[gradeKey] = number`（完登数）
- `boards[boardKey] = boolean`（ON/OFF）

### 5.2 合計点算出
- `total = sum(counts[k] * gradePoints[k]) + sum(boards[b] ? boardPoints[b] : 0)`

### 5.3 リアルタイム更新
- state変更（+/-、トグル）→即座に再計算→合計を更新

---

## 6. 入力値の保存（期限付きキャッシュ）

### 6.1 目的
- 一定時間は入力を保持して、誤操作・リロード・ブラウザ再起動でも復帰できる。

### 6.2 方式
- `localStorage` を使用
- 保存データに `savedAt`（UNIX ms）を持たせ、期限超過で破棄。

### 6.3 仕様
- 保存キー：`nobocon-calc:v1`
- 保存タイミング：
  - state変更のたびに保存（300ms程度のdebounce推奨）
- TTL（保持期限）：
  - **12時間**（定数として切り出し、将来変更可能に）
- 起動時：
  - localStorageにデータがあり、`now - savedAt <= TTL` なら復元
  - 期限切れなら削除して初期化
- リセット：
  - state初期化 + localStorage削除

---

## 7. 初期値
- 完登数：すべて `0`
- のぼコンボード：すべて `OFF`

---

## 8. エラーハンドリング／制約
- 完登数は整数のみ、0未満禁止
- localStorage が使えない（プライベートモード等）場合：
  - 保存機能は無効化し、アプリ自体は動作継続
  - 画面下部に小さく通知（任意）

---

## 9. UI/UX 要件（Tailwind CSS）
- モバイルファースト（片手操作しやすい）
- 重要度順に視線誘導：
  1) 合計点
  2) 級・段カウンター
  3) ボード
- ボタンは押しやすい大きさ、誤タップ防止（余白確保）
- 状態が明確：
  - トグルONは明確に視覚変化
  - `-` が無効（完登数0時）は disabled 表示
- 可能なら軽いフィードバック（押下時のactive、focusリング）

---

## 10. アクセシビリティ
- ボタン・トグルはキーボード操作可能
- `aria-label` 付与（例：「8Q 完登数を増やす」）
- フォーカス可視化（focus ring）

---

## 11. 技術要件（GitHub Pages 公開前提）

### 11.1 採用技術（推奨）
- **Vite + React + TypeScript**
- **Tailwind CSS**
- 状態管理：React（`useReducer` 推奨）
- 永続化：`localStorage`（TTL付き）
- テスト：必須ではない（将来追加できる構成にしておく）

### 11.2 アーキテクチャ方針
- **フロントのみで完結するSPA**
- サーバサイド処理・DBは不要
- API通信なし（将来拡張を想定し、ロジックとUIは分離）

### 11.3 GitHub Pages 対応
- ビルド成果物を `gh-pages` ブランチ（または `docs/`）に配置して配信
- ルーティングは単一ページのため問題なし（React Router不要）
- ただし GitHub Pages はサブパス配信になるため、Vite の `base` 設定を適切に行う
  - 例：`base: '/<repo-name>/'`
- デプロイは GitHub Actions 推奨（手動でも可）

### 11.4 推奨ディレクトリ構成（例）
- `src/`
  - `components/`
  - `state/`（reducer, actions, selectors）
  - `lib/`（score定数、storage、utils）
- `public/`
- `index.html`

### 11.5 パフォーマンス要件（目標）
- 初回表示：軽量（画像・重い依存を使わない）
- 入力操作：遅延を感じない（即時反映）

---

## 12. データ構造（例）

### 12.1 定数
- `gradePoints`：
  - `{"8Q":100,"7Q":200,"6Q":300,"5Q":400,"4Q":500,"3Q":650,"2Q":1050,"1Q":1400,"1D":2500,"2D":4000}`
- `boardPoints`：
  - `{"8Q(91)":100,"7Q(92)":200,"6Q(93)":300,"5Q(94)":400,"4Q(95)":500,"3Q(96)":650,"3Q(97)":650,"2Q(98)":1050}`

### 12.2 state（TypeScript想定）
```ts
type State = {
  counts: Record<string, number>;
  boards: Record<string, boolean>;
  savedAt?: number; // 保存時のみ
};
```


### 13. 受け入れ条件（Acceptance Criteria）
1. 初期表示で合計は 0 pt
2. 任意の級で + を押すと完登数が増え、合計点が正しく加算される
3. - を押しても完登数は0未満にならない（0のときは無効化される）
4. のぼコンボードを押すと ON/OFF が切り替わり、合計点が増減する
5. 「全て選択」で全ボードがONになり、合計が正しく増える
6. 再読み込みしてもTTL内なら入力が復元される
7. TTLを超えると復元されず初期化される
8. 常に合計点が最上部に表示され続ける（スクロールしても見える）
9. GitHub Pages 上で正しく表示・動作する（サブパス配信でもCSS/JSが崩れない）

### 14. 今回スコープ外（将来拡張候補）
- 競技ごとのプリセット切替（点数表を複数持つ）
- 入力の共有（URLクエリ、JSONエクスポート）
- PWA対応（より強いオフライン）

### 15. 実装メモ（Codex向け指示のポイント）
- useReducer でイベント駆動（INCREMENT/DECREMENT/TOGGLE_BOARD/TOGGLE_ALL/RESET/RESTORE）
- localStorage保存は useEffect + debounce
- sticky header で合計点固定
- UIはカード化してタップしやすい密度に調整
- GitHub Pages 配信のため、Vite の base 設定と GitHub Actions デプロイを忘れない
